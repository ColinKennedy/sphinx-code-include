

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>ways.base.descriptor &mdash; Ways 1.0.0b1 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript">
          var DOCUMENTATION_OPTIONS = {
              URL_ROOT:'../../../',
              VERSION:'1.0.0b1',
              LANGUAGE:'None',
              COLLAPSE_INDEX:false,
              FILE_SUFFIX:'.html',
              HAS_SOURCE:  true,
              SOURCELINK_SUFFIX: '.txt'
          };
      </script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
    
    <script type="text/javascript" src="../../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../../index.html" class="icon icon-home"> Ways
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../why.html">Why</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../getting_started.html">Getting Started</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../descriptors.html">Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plugin_basics.html">Plugin Basics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plugin_advanced.html">Advanced Plugins</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../parsing.html">Parsing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../api_details.html">API Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../troubleshooting.html">Troubleshooting</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../common_patterns.html">Common Patterns And Best Practices</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../summary.html">API Summary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ways.html">API Documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Ways</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../../ways.html">ways</a> &raquo;</li>
        
      <li>ways.base.descriptor</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for ways.base.descriptor</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>

<span class="sd">&#39;&#39;&#39;A module that holds classes which abstract how Plugin objects are created.</span>

<span class="sd">A descriptor string could be a path to a file or folder or even to a database</span>

<span class="sd">&#39;&#39;&#39;</span>


<span class="c1"># IMPORT STANDARD LIBRARIES</span>
<span class="c1"># scspell-id: 3c62e4aa-c280-11e7-be2b-382c4ac59cfd</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">tempfile</span>
<span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">collections</span>

<span class="c1"># IMPORT THIRD-PARTY LIBRARIES</span>
<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">import</span> <span class="nn">yamlordereddictloader</span>

<span class="c1"># IMPORT LOCAL LIBRARIES</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">plugin</span> <span class="k">as</span> <span class="n">plug</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">situation</span> <span class="k">as</span> <span class="n">sit</span>
<span class="kn">from</span> <span class="nn">..core</span> <span class="k">import</span> <span class="n">check</span>
<span class="kn">from</span> <span class="nn">..helper</span> <span class="k">import</span> <span class="n">common</span>
<span class="kn">from</span> <span class="nn">..helper</span> <span class="k">import</span> <span class="n">dict_classes</span>

<span class="n">GLOBALS_KEY</span> <span class="o">=</span> <span class="s1">&#39;globals&#39;</span>
<span class="n">PLUGIN_INFO_FILE_NAME</span> <span class="o">=</span> <span class="s1">&#39;.ways_plugin_info&#39;</span>


<div class="viewcode-block" id="FileDescriptor"><a class="viewcode-back" href="../../../descriptor.html#ways.api.FileDescriptor">[docs]</a><span class="k">class</span> <span class="nc">FileDescriptor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;A generic class that creates Plugin objects from a file, on-disk.</span>

<span class="sd">    Note:</span>
<span class="sd">        Any FileDescriptor class that returns back Plugin objects is valid</span>
<span class="sd">        (Descriptors can query from a database, locally on file, etc, etc.</span>
<span class="sd">        It&#39;s all good) except there is one major requirement. FileDescriptor-like</span>
<span class="sd">        objects cannot append asynchronously. In other words,</span>
<span class="sd">        If a FileDescriptor manages threads that each find Plugin objects and</span>
<span class="sd">        append to a list of Plugin objects whenever each thread finishes, the</span>
<span class="sd">        Plugin objects might append out of order - which will create</span>
<span class="sd">        results that will be hard to debug.</span>

<span class="sd">        It&#39;s recommended to not use threading at all unless this return process</span>
<span class="sd">        is managed (like with a queue or some other kind of idea).</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create the object and initialize its default values.</span>

<span class="sd">        Args:</span>
<span class="sd">            items (iterable[str] or str):</span>
<span class="sd">                The paths that this FileDescriptor looks for to find Plugin objects.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FileDescriptor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">=</span> <span class="n">check</span><span class="o">.</span><span class="n">force_itertype</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_default_plugin_info</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;assignment&#39;</span><span class="p">:</span> <span class="n">common</span><span class="o">.</span><span class="n">DEFAULT_ASSIGNMENT</span><span class="p">,</span>
            <span class="s1">&#39;recursive&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_conform_plugin_info</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Mutate the input&#39;s hierarchy to a tuple that this object can use.</span>

<span class="sd">        Warning:</span>
<span class="sd">            This method does not return and mutates the object directly,</span>
<span class="sd">            without making a copy.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;hierarchy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">split_hierarchy</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;hierarchy&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_get_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;list[str]: Get all supported Plugin files.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span>

        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_plugin_files</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>

<div class="viewcode-block" id="FileDescriptor.get_supported_extensions"><a class="viewcode-back" href="../../../descriptor.html#ways.api.FileDescriptor.get_supported_extensions">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_supported_extensions</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;list[str]: The Plugin file extensions.&#39;&#39;&#39;</span>
        <span class="n">loaders</span> <span class="o">=</span> <span class="n">get_loaders</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">extension</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">loaders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;extensions&#39;</span><span class="p">])</span></div>

<div class="viewcode-block" id="FileDescriptor.filter_plugin_files"><a class="viewcode-back" href="../../../descriptor.html#ways.api.FileDescriptor.filter_plugin_files">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">filter_plugin_files</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Only get back the files that are likely to be plugin files.&#39;&#39;&#39;</span>
        <span class="n">extensions</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">get_supported_extensions</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">name</span> <span class="o">!=</span> <span class="n">PLUGIN_INFO_FILE_NAME</span> <span class="ow">and</span> <span class="n">ext</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="n">extensions</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">path</span></div>

<div class="viewcode-block" id="FileDescriptor.get_plugins"><a class="viewcode-back" href="../../../descriptor.html#ways.api.FileDescriptor.get_plugins">[docs]</a>    <span class="k">def</span> <span class="nf">get_plugins</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Get the Plugin objects that this instance is able to find.</span>

<span class="sd">        Note:</span>
<span class="sd">            This object will sort the items it is given before retrieving its</span>
<span class="sd">            Plugin objects so files/folders that are given different priorities</span>
<span class="sd">            depending on how their paths are named.</span>

<span class="sd">        Args:</span>
<span class="sd">            items (iterable[str] or str):</span>
<span class="sd">                The paths that this FileDescriptor looks for to find Plugin objects.</span>
<span class="sd">                If not items are given, the instance&#39;s stored items are used,</span>
<span class="sd">                instead.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[:class:`ways.api.Plugin`]: The plugins.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span>

        <span class="n">files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_files</span><span class="p">(</span><span class="n">items</span><span class="p">)</span>

        <span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Turn files into gold - Plugin gold!</span>
        <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">try_load</span><span class="p">(</span><span class="n">file_</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="c1"># TODO : Needs logging</span>
                <span class="k">continue</span>

            <span class="c1"># TODO : Make it so we don&#39;t load this for each file.</span>
            <span class="c1">#        Or at the very least for FolderDescriptor (since it&#39;s)</span>
            <span class="c1">#        guaranteed to the same information, each time</span>
            <span class="c1">#</span>
            <span class="n">plugin_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plugin_info</span><span class="p">(</span><span class="n">file_</span><span class="p">)</span>

            <span class="c1"># If the Plugin Sheet has a &#39;globals&#39; section, get its info</span>
            <span class="n">assignment</span> <span class="o">=</span> <span class="n">plugin_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assignment&#39;</span><span class="p">,</span> <span class="n">common</span><span class="o">.</span><span class="n">DEFAULT_ASSIGNMENT</span><span class="p">)</span>
            <span class="n">plugin_assignment_</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;globals&#39;</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assignment&#39;</span><span class="p">,</span> <span class="n">assignment</span><span class="p">)</span>

            <span class="c1"># Iterate over the plugins found in the Plugin Sheet</span>
            <span class="k">for</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">six</span><span class="o">.</span><span class="n">iteritems</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;plugins&#39;</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_conform_plugin_info</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>

                <span class="c1"># If the plugin has a specific assignment given, use that,</span>
                <span class="c1"># instead of what might be written in a config file or in globals</span>
                <span class="c1">#</span>
                <span class="n">assignment_</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;assignment&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">assignment_</span><span class="p">:</span>
                    <span class="n">plugin_assignment</span> <span class="o">=</span> <span class="n">assignment_</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plugin_assignment</span> <span class="o">=</span> <span class="n">plugin_assignment_</span>

                <span class="n">plugins</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_build_plugins</span><span class="p">(</span><span class="n">file_</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">plugin_assignment</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">plugins</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_build_plugins</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">assignment</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create a Plugin or multiple Plugin objects.</span>

<span class="sd">        This method is meant to be used with get_plugins. It just exists</span>
<span class="sd">        to make it get_plugins more readable.</span>

<span class="sd">        Args:</span>
<span class="sd">            source (str):</span>
<span class="sd">                The location to a file on disk that defined plugin.</span>
<span class="sd">            name (str):</span>
<span class="sd">                The key that was used in the Plugin Sheet file where the plugin</span>
<span class="sd">                was defined.</span>
<span class="sd">            info (dict[str]):</span>
<span class="sd">                Any data about the plugin to include when the Plugin initializes.</span>
<span class="sd">                &quot;uses&quot; is retrieved to figure out if plugin is an absolute or</span>
<span class="sd">                relative plugin.</span>
<span class="sd">            assignment (str):</span>
<span class="sd">                The placement that this Plugin will go into.</span>

<span class="sd">        Returns:</span>
<span class="sd">            list[:class:`ways.api.DataPlugin`]:</span>
<span class="sd">                The generated plugins. It will make one Plugin object if</span>
<span class="sd">                info.get(&#39;uses&#39;, []) is empty. If &quot;uses&quot; is not empty, it will</span>
<span class="sd">                create one Plugin for each item in &quot;uses&quot;.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">duplicate_uses_message</span> <span class="o">=</span> <span class="s1">&#39;Plugin: &quot;</span><span class="si">{plug}</span><span class="s1">&quot; has duplicate hierarchies &#39;</span> \
                                 <span class="s1">&#39;in uses, &quot;</span><span class="si">{uses}</span><span class="s1">&quot;. Remove all duplicates.&#39;</span>

        <span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># There are two types of Context-Plugins, absolute and relative</span>
        <span class="c1"># If a plugin has &#39;uses&#39; defined, that plugin is relative</span>
        <span class="c1"># because it needs another plugin/Context to function.</span>
        <span class="c1">#</span>
        <span class="c1"># We use all Context hierarchies defined in &#39;uses&#39; to create</span>
        <span class="c1"># absolute plugins from each relative plugin</span>
        <span class="c1">#</span>
        <span class="n">uses</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uses&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">if</span> <span class="n">uses</span><span class="p">:</span>
            <span class="n">duplicates</span> <span class="o">=</span> <span class="n">_get_duplicates</span><span class="p">(</span><span class="n">uses</span><span class="p">)</span>

            <span class="c1"># TODO : &quot;if duplicates:&quot; stops bugs from happening</span>
            <span class="c1">#        if a user wrote a plugin that has duplicate items in</span>
            <span class="c1">#        &#39;uses&#39;. Ways likes to think that this is usually a</span>
            <span class="c1">#        copy/paste accident and is not intentional.</span>
            <span class="c1">#        and should never be intentional</span>
            <span class="c1">#</span>
            <span class="c1">#        Raising an error is really bad so we instead</span>
            <span class="c1">#        should just &quot;continue&quot; and log the failure so that</span>
            <span class="c1">#        a user can look it up, later</span>
            <span class="c1">#</span>
            <span class="k">if</span> <span class="n">duplicates</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">duplicate_uses_message</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">plug</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">uses</span><span class="o">=</span><span class="n">duplicates</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">hierarchy</span> <span class="ow">in</span> <span class="n">uses</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">is_invalid_plugin</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
                    <span class="k">continue</span>

                <span class="n">context</span> <span class="o">=</span> <span class="n">sit</span><span class="o">.</span><span class="n">get_context</span><span class="p">(</span>
                    <span class="n">hierarchy</span><span class="p">,</span> <span class="n">assignment</span><span class="o">=</span><span class="n">assignment</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">info_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_make_relative_context_absolute</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">context</span><span class="p">)</span>

                <span class="n">plugin</span> <span class="o">=</span> <span class="n">plug</span><span class="o">.</span><span class="n">DataPlugin</span><span class="p">(</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                    <span class="n">sources</span><span class="o">=</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">),</span>
                    <span class="n">info</span><span class="o">=</span><span class="n">dict_classes</span><span class="o">.</span><span class="n">ReadOnlyDict</span><span class="p">(</span><span class="n">info_</span><span class="p">),</span>
                    <span class="n">assignment</span><span class="o">=</span><span class="n">assignment</span><span class="p">)</span>
                <span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plugin</span><span class="p">,</span> <span class="n">assignment</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plugin</span> <span class="o">=</span> <span class="n">plug</span><span class="o">.</span><span class="n">DataPlugin</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">sources</span><span class="o">=</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="p">),</span>
                <span class="n">info</span><span class="o">=</span><span class="n">dict_classes</span><span class="o">.</span><span class="n">ReadOnlyDict</span><span class="p">(</span><span class="n">info</span><span class="p">),</span>
                <span class="n">assignment</span><span class="o">=</span><span class="n">assignment</span><span class="p">)</span>
            <span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">plugin</span><span class="p">,</span> <span class="n">assignment</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">plugins</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_make_relative_context_absolute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">parent</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Rebuild the plugin information, using a parent Context.</span>

<span class="sd">        Note:</span>
<span class="sd">            Not every item in our info is resolved to absolute immediately.</span>
<span class="sd">            Only the plugins that must be absolute (like hierarchy) are changed.</span>
<span class="sd">            For all the other plugins that may still be relative, like mapping,</span>
<span class="sd">            max_folder, etc., it&#39;s up to the Context to resolve it.</span>

<span class="sd">        Args:</span>
<span class="sd">            info (dict[str]):</span>
<span class="sd">                The information to resolve into absolute information.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str]: The resolved, absolute information.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="n">info</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
        <span class="n">hierarchy</span> <span class="o">=</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;hierarchy&#39;</span><span class="p">]</span>
        <span class="n">hierarchy_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">parent_hierarchy</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">get_hierarchy</span><span class="p">()</span>

        <span class="n">root_was_found</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">piece</span> <span class="ow">in</span> <span class="n">hierarchy</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">common</span><span class="o">.</span><span class="n">PARENT_TOKEN</span> <span class="ow">in</span> <span class="n">piece</span><span class="p">:</span>
                <span class="n">root_was_found</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">piece</span> <span class="o">=</span> <span class="n">piece</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">HIERARCHY_SEP</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parent_hierarchy</span><span class="p">))</span>
                <span class="c1"># Extend the hierarchy so that we avoid accidentally making</span>
                <span class="c1"># a nested tuple (a tuple with tuples in it)</span>
                <span class="c1">#</span>
                <span class="n">new_piece_hierarchy</span> <span class="o">=</span> <span class="n">common</span><span class="o">.</span><span class="n">split_hierarchy</span><span class="p">(</span><span class="n">piece</span><span class="p">)</span>
                <span class="n">hierarchy_</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_piece_hierarchy</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">hierarchy_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">piece</span><span class="p">)</span>

        <span class="c1"># If the user did not write {root} anywhere in the relative Context,</span>
        <span class="c1"># assume that they just wanted to append its hierarchy to the parent</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">root_was_found</span><span class="p">:</span>
            <span class="n">hierarchy_</span> <span class="o">=</span> <span class="n">parent_hierarchy</span> <span class="o">+</span> <span class="n">hierarchy</span>

        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;hierarchy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">hierarchy_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">info</span>

<div class="viewcode-block" id="FileDescriptor.get_plugin_info"><a class="viewcode-back" href="../../../descriptor.html#ways.api.FileDescriptor.get_plugin_info">[docs]</a>    <span class="k">def</span> <span class="nf">get_plugin_info</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Given some file path, get its metadata info.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): The path to some directory containing plugin objects.</span>

<span class="sd">        Returns:</span>
<span class="sd">            dict[str]: The information about this plugin path.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">def</span> <span class="nf">find_info_file</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Look up a directory, starting at some path, for an info file.&#39;&#39;&#39;</span>
            <span class="n">plugin_info_file</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">last_item</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;.unimportant_folder_that_will_be_removed&#39;</span><span class="p">)</span>

            <span class="k">while</span> <span class="n">last_item</span> <span class="o">!=</span> <span class="n">path</span><span class="p">:</span>
                <span class="n">last_item</span> <span class="o">=</span> <span class="n">path</span>
                <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">extension</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_supported_extensions</span><span class="p">():</span>
                    <span class="n">plugin_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">PLUGIN_INFO_FILE_NAME</span> <span class="o">+</span> <span class="n">extension</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">plugin_file</span><span class="p">):</span>
                        <span class="n">plugin_info_file</span> <span class="o">=</span> <span class="n">plugin_file</span>
                        <span class="k">break</span>

            <span class="k">return</span> <span class="n">plugin_info_file</span>

        <span class="n">item</span> <span class="o">=</span> <span class="n">find_info_file</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">item</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">try_load</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_plugin_info</span>
        <span class="k">return</span> <span class="n">data</span></div>

    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Check if every path in this object exists in another Descriptor.&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">items</span></div>


<div class="viewcode-block" id="FolderDescriptor"><a class="viewcode-back" href="../../../descriptor.html#ways.api.FolderDescriptor">[docs]</a><span class="k">class</span> <span class="nc">FolderDescriptor</span><span class="p">(</span><span class="n">FileDescriptor</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;A generic abstraction that helps find Plugin objects for our code.</span>

<span class="sd">    Note:</span>
<span class="sd">        Any FileDescriptor class that returns back Plugin objects is valid</span>
<span class="sd">        (Descriptors can query from a database, locally on file, etc, etc.</span>
<span class="sd">        It&#39;s all good) except there is one major requirement. FileDescriptor-like</span>
<span class="sd">        objects cannot append asynchronously. In other words,</span>
<span class="sd">        If a FileDescriptor manages threads that each find Plugin objects and</span>
<span class="sd">        append to a list of Plugin objects whenever each thread finishes, the</span>
<span class="sd">        Plugin objects might append out of order - which will create</span>
<span class="sd">        results that will be hard to debug.</span>

<span class="sd">        It&#39;s recommended to not use threading at all unless this return process</span>
<span class="sd">        is managed (like with a queue or some other kind of idea).</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create the object and initialize its default values.</span>

<span class="sd">        Args:</span>
<span class="sd">            items (iterable[str] or str):</span>
<span class="sd">                The paths that this Descriptor looks for to find Plugin objects.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">FolderDescriptor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_get_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">items</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">items</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span>

        <span class="n">file_paths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_plugin_info</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="c1"># Figure out how to iterate to get the files we need</span>
            <span class="k">if</span> <span class="n">metadata</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;recursive&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_default_plugin_info</span><span class="p">[</span><span class="s1">&#39;recursive&#39;</span><span class="p">]):</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file_</span><span class="p">)</span> <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span>
                         <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="k">for</span> <span class="n">file_</span> <span class="ow">in</span> <span class="n">files</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">files</span> <span class="o">=</span> <span class="p">(</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">glob</span><span class="o">.</span><span class="n">iglob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span><span class="p">))</span>
                         <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>

            <span class="n">file_paths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filter_plugin_files</span><span class="p">(</span><span class="n">files</span><span class="p">)))</span>

        <span class="k">return</span> <span class="n">file_paths</span></div>


<div class="viewcode-block" id="GitLocalDescriptor"><a class="viewcode-back" href="../../../descriptor.html#ways.api.GitLocalDescriptor">[docs]</a><span class="k">class</span> <span class="nc">GitLocalDescriptor</span><span class="p">(</span><span class="n">FolderDescriptor</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;An object to describe a local git repository.</span>

<span class="sd">    This class conforms its input to files that its base class can</span>
<span class="sd">    read and then calls it. Otherwise that, it&#39;s not special.</span>

<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="s1">&#39;master&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Create this instance and store its path and branch information.</span>

<span class="sd">        Args:</span>
<span class="sd">            path (str): The root path to the local git repository.</span>
<span class="sd">            items (iterable[str]):</span>
<span class="sd">                The folders that contain plugin files. These paths can be either</span>
<span class="sd">                absolute or relative to path.</span>
<span class="sd">            branch (:obj:`str`, optional):</span>
<span class="sd">                The branch of the git repository to use.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">path</span> <span class="o">=</span> <span class="n">path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">branch</span> <span class="o">=</span> <span class="n">branch</span>

        <span class="n">items_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">check</span><span class="o">.</span><span class="n">force_itertype</span><span class="p">(</span><span class="n">items</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;File/Folder: &quot;</span><span class="si">{0}</span><span class="s1">&quot; does not exist&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isabs</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
                <span class="n">items_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                <span class="k">continue</span>

            <span class="n">item_</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path</span><span class="p">,</span> <span class="n">item</span><span class="p">))</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">item_</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span>
                    <span class="s1">&#39;File/Folder: &quot;</span><span class="si">{}</span><span class="s1">&quot; is relative but no absolute path could &#39;</span>
                    <span class="s1">&#39;be found using path, &quot;</span><span class="si">{}</span><span class="s1">&quot;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">path</span><span class="p">))</span>
            <span class="n">items_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item_</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">GitLocalDescriptor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">items</span><span class="o">=</span><span class="n">items_</span><span class="p">)</span></div>


<div class="viewcode-block" id="GitRemoteDescriptor"><a class="viewcode-back" href="../../../descriptor.html#ways.api.GitRemoteDescriptor">[docs]</a><span class="k">class</span> <span class="nc">GitRemoteDescriptor</span><span class="p">(</span><span class="n">GitLocalDescriptor</span><span class="p">):</span>

    <span class="sd">&#39;&#39;&#39;A Descriptor that clones an online Git repository.&#39;&#39;&#39;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">url</span><span class="p">,</span> <span class="n">items</span><span class="p">,</span> <span class="n">path</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="s1">&#39;master&#39;</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Clone the repository locally and read its contents for plugins.</span>

<span class="sd">        Args:</span>
<span class="sd">            url (str):</span>
<span class="sd">                The absolute URL to some git repository local/remote repo.</span>
<span class="sd">            items (list[str]):</span>
<span class="sd">                The paths to search for plugin files. These items can be</span>
<span class="sd">                absolute paths or paths that are relative to the cloned repo.</span>
<span class="sd">            path (:obj:`str`, optional):</span>
<span class="sd">                The location to clone this repository into.</span>
<span class="sd">                If the directory exists, it&#39;s assumed that this repository</span>
<span class="sd">                was already cloned to the location and its contents are read</span>
<span class="sd">                directly. If it does not exist, the repo is cloned there.</span>
<span class="sd">                If no path is given, a temporary directory is used.</span>
<span class="sd">            branch (:obj:`str`, optional):</span>
<span class="sd">                The branch in this repository to checkout and use.</span>
<span class="sd">                Default: &#39;master&#39;.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="c1"># We do an inner import here for Python 3.3 - Because it looks like</span>
        <span class="c1"># GitPython isn&#39;t supported for that Python version</span>
        <span class="c1"># (pip install GitPython failed when I tried it)</span>
        <span class="c1">#</span>
        <span class="c1"># TODO : Find an alternative for GitPython</span>
        <span class="c1">#</span>
        <span class="kn">import</span> <span class="nn">git</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="p">:</span>
            <span class="n">path</span> <span class="o">=</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">()</span>

        <span class="n">repo</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">repo</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.git&#39;</span><span class="p">):</span>
            <span class="n">repo</span> <span class="o">=</span> <span class="n">repo</span><span class="p">[:</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">repo</span><span class="p">)):</span>
            <span class="n">git</span><span class="o">.</span><span class="n">Repo</span><span class="o">.</span><span class="n">clone_from</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">path</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">GitRemoteDescriptor</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">items</span><span class="o">=</span><span class="n">items</span><span class="p">,</span> <span class="n">branch</span><span class="o">=</span><span class="n">branch</span><span class="p">)</span></div>


<div class="viewcode-block" id="is_invalid_plugin"><a class="viewcode-back" href="../../../descriptor.html#ways.api.is_invalid_plugin">[docs]</a><span class="k">def</span> <span class="nf">is_invalid_plugin</span><span class="p">(</span><span class="n">hierarchy</span><span class="p">,</span> <span class="n">info</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Detect if a plugin&#39;s hierarchy is invalid, given its loaded information.</span>

<span class="sd">    A plugin that has cyclic dependencies is considered &quot;invalid&quot;.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; cat plugin.yml</span>
<span class="sd">        ... plugins:</span>
<span class="sd">        ...     relative_plugin1:</span>
<span class="sd">        ...         hierarchy: mocap</span>
<span class="sd">        ...         mapping: &#39;{root}/scenes/mocap&#39;</span>
<span class="sd">        ...         uses:</span>
<span class="sd">        ...             - mocap</span>

<span class="sd">    In the above example, that plugin refers to itself and could cause</span>
<span class="sd">    runtime errors.</span>

<span class="sd">    Args:</span>
<span class="sd">        hierarchy (str): Some hierarchy to check.</span>
<span class="sd">        info (dict[str]):</span>
<span class="sd">            The loaded information of some plugin from a Plugin Sheet file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        If the plugin is valid.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">uses</span> <span class="o">=</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;uses&#39;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">joined</span> <span class="o">=</span> <span class="p">(</span><span class="n">common</span><span class="o">.</span><span class="n">HIERARCHY_SEP</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hierarchy&#39;</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">()))</span>
    <span class="k">return</span> <span class="n">hierarchy</span> <span class="ow">in</span> <span class="n">uses</span> <span class="ow">and</span> <span class="n">joined</span> <span class="ow">in</span> <span class="n">uses</span></div>


<span class="k">def</span> <span class="nf">_get_duplicates</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get all items in some iterable object that occur more than once.</span>

<span class="sd">    This is just a helper function - because the original code was hard to read.</span>

<span class="sd">    Args:</span>
<span class="sd">        obj (iter): The object to test.</span>

<span class="sd">    Returns:</span>
<span class="sd">        list: The duplicate items.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">item</span> <span class="k">for</span> <span class="n">item</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">collections</span><span class="o">.</span><span class="n">Counter</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">]</span>


<span class="nd">@common</span><span class="o">.</span><span class="n">memoize</span>
<span class="k">def</span> <span class="nf">get_loaders</span><span class="p">():</span>
    <span class="sd">&#39;&#39;&#39;Get descriptions for how we load Plugin Sheet files.</span>

<span class="sd">    This method will return different options, depending on what modules are</span>
<span class="sd">    installed in your environment. For example, pyyaml (import yaml) isn&#39;t</span>
<span class="sd">    shipped with Python in Windows, by default. YAML descriptions are only</span>
<span class="sd">    loaded if they&#39;re installed on the system.</span>

<span class="sd">    Note:</span>
<span class="sd">        This function is cached after it is run.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict[str]: The installed loaders.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">load_hook</span><span class="p">(</span><span class="n">info</span><span class="p">):</span>
        <span class="sd">&#39;&#39;&#39;Modify some loaded data after information has been loaded.&#39;&#39;&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;groups&#39;</span> <span class="ow">in</span> <span class="n">info</span><span class="p">:</span>
            <span class="n">info</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;groups&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="k">def</span> <span class="nf">use_yaml</span><span class="p">():</span>
        <span class="sd">&#39;&#39;&#39;Try to load a description for YAML.&#39;&#39;&#39;</span>
        <span class="n">extensions</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.yml&#39;</span><span class="p">,</span> <span class="s1">&#39;.yaml&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;If this item is a valid YAML file.&#39;&#39;&#39;</span>
            <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">yaml</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">load_wrap</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">after</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;Load a file using func and then run another function after load.</span>

<span class="sd">            Args:</span>
<span class="sd">                file_path (str): The absolute path to a file to load.</span>
<span class="sd">                func (callable[str]): The loader function to run</span>
<span class="sd">                                      (yaml.safe_load/json.load/etc)</span>
<span class="sd">                after (callable[str]): The function to load after file_path</span>
<span class="sd">                                       has been deserialized.</span>

<span class="sd">            Returns:</span>
<span class="sd">                The loaded information from func.</span>

<span class="sd">            &#39;&#39;&#39;</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span>
            <span class="n">after</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">value</span>

        <span class="n">safe_load</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yamlordereddictloader</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
        <span class="n">safe_load_function</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">load_wrap</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">safe_load</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">load_hook</span><span class="p">)</span>
        <span class="n">load</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yamlordereddictloader</span><span class="o">.</span><span class="n">Loader</span><span class="p">)</span>
        <span class="n">load_function</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">load_wrap</span><span class="p">,</span> <span class="n">func</span><span class="o">=</span><span class="n">load</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="n">load_hook</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;yaml&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;exceptions&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">constructor</span><span class="o">.</span><span class="n">ConstructorError</span><span class="p">,</span> <span class="p">),</span>
                <span class="s1">&#39;extensions&#39;</span><span class="p">:</span> <span class="n">extensions</span><span class="p">,</span>
                <span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="n">is_valid</span><span class="p">,</span>
                <span class="s1">&#39;load&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">safe_load_function</span><span class="p">,</span> <span class="n">load_function</span><span class="p">),</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">use_json</span><span class="p">():</span>
        <span class="sd">&#39;&#39;&#39;Try to load a description for JSON.&#39;&#39;&#39;</span>
        <span class="n">extensions</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;.json&#39;</span><span class="p">,</span> <span class="p">)</span>

        <span class="k">def</span> <span class="nf">is_valid</span><span class="p">(</span><span class="n">item</span><span class="p">):</span>
            <span class="sd">&#39;&#39;&#39;If this item is a valid JSON file.&#39;&#39;&#39;</span>
            <span class="k">return</span> <span class="n">item</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">extensions</span><span class="p">)</span>

        <span class="n">load_function</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">,</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">load_hook</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;json&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;exceptions&#39;</span><span class="p">:</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">TypeError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">),</span>
                <span class="s1">&#39;extensions&#39;</span><span class="p">:</span> <span class="n">extensions</span><span class="p">,</span>
                <span class="s1">&#39;is_valid&#39;</span><span class="p">:</span> <span class="n">is_valid</span><span class="p">,</span>
                <span class="s1">&#39;load&#39;</span><span class="p">:</span> <span class="p">(</span><span class="n">load_function</span><span class="p">,</span> <span class="p">),</span>
            <span class="p">},</span>
        <span class="p">}</span>

    <span class="n">output_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="p">[</span><span class="n">use_json</span><span class="p">,</span> <span class="n">use_yaml</span><span class="p">]:</span>
        <span class="n">output_dict</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">loader</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">output_dict</span>


<div class="viewcode-block" id="try_load"><a class="viewcode-back" href="../../../descriptor.html#ways.api.try_load">[docs]</a><span class="k">def</span> <span class="nf">try_load</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Try our best to load the given file, using a number of different methods.</span>

<span class="sd">    The path is assumed to be a file that is serialized, like JSON or YAML.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str):</span>
<span class="sd">            The absolute path to some file with serialized data.</span>
<span class="sd">        default (:obj:`dict`, optional):</span>
<span class="sd">            The information to return back if no data could be found.</span>
<span class="sd">            Default is an empty dict.</span>

<span class="sd">    Returns:</span>
<span class="sd">        dict: The information stored on this object.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">not_found_raise_error</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>  <span class="c1"># pylint: disable=unused-argument</span>
        <span class="sd">&#39;&#39;&#39;Just a generic function that will raise an error.</span>

<span class="sd">        This function is never run unless no loader was found for the given path.</span>

<span class="sd">        &#39;&#39;&#39;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span>

    <span class="k">if</span> <span class="n">default</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">default</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">default</span>

    <span class="c1"># Try to find a recommended loader</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">find_loader</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
        <span class="n">loader</span> <span class="o">=</span> <span class="n">not_found_raise_error</span>

    <span class="c1"># Have some fallback loaders ready, in case the first loader fails</span>
    <span class="n">loaders</span> <span class="o">=</span> <span class="n">get_loaders</span><span class="p">()</span>
    <span class="n">loader_options</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">loader</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">loaders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                           <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">info</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">])</span>

    <span class="n">all_other_load_options</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">loader_options</span><span class="p">)</span> <span class="o">-</span> <span class="p">{</span><span class="n">loader</span><span class="p">}</span>

    <span class="c1"># Try the loaders until some data could be found using one of them</span>

    <span class="n">known_loader_exceptions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">exception</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="ow">in</span> <span class="n">loaders</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                                    <span class="k">for</span> <span class="n">exception</span> <span class="ow">in</span> <span class="n">info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;exceptions&#39;</span><span class="p">,</span> <span class="p">[]))</span>

    <span class="k">for</span> <span class="n">loader_option</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">([</span><span class="n">loader</span><span class="p">],</span> <span class="n">all_other_load_options</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file_</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">loader_option</span><span class="p">(</span><span class="n">file_</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">known_loader_exceptions</span><span class="p">:</span>  <span class="c1"># pylint: disable=catching-non-exception</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">default</span></div>


<div class="viewcode-block" id="find_loader"><a class="viewcode-back" href="../../../descriptor.html#ways.api.find_loader">[docs]</a><span class="k">def</span> <span class="nf">find_loader</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get the callable method needed to parse this file.</span>

<span class="sd">    Args:</span>
<span class="sd">        path (str): The path to get the loader of.</span>

<span class="sd">    Returns:</span>
<span class="sd">        callable[file]: A method that is used to load a Python file object</span>
<span class="sd">                        for the given path.</span>

<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">most_preferred_load_index</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">loader</span> <span class="ow">in</span> <span class="n">get_loaders</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">loader</span><span class="p">[</span><span class="s1">&#39;is_valid&#39;</span><span class="p">](</span><span class="n">lower</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">loader</span><span class="p">[</span><span class="s1">&#39;load&#39;</span><span class="p">][</span><span class="n">most_preferred_load_index</span><span class="p">]</span>

    <span class="n">extensions</span> <span class="o">=</span> <span class="n">FileDescriptor</span><span class="o">.</span><span class="n">get_supported_extensions</span><span class="p">()</span>

    <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
        <span class="s1">&#39;Path: &quot;</span><span class="si">{path}</span><span class="s1">&quot; has no implementation. Expected one of &quot;</span><span class="si">{opt}</span><span class="s1">&quot;.&#39;</span>
        <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">path</span><span class="p">,</span> <span class="n">opt</span><span class="o">=</span><span class="n">extensions</span><span class="p">))</span></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Colin Kennedy

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>